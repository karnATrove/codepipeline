<?php

namespace WarehouseBundle\Repository;

use Doctrine\ORM\EntityRepository;
use WarehouseBundle\Entity\Incoming;
use WarehouseBundle\Entity\IncomingStatus;
use WarehouseBundle\Model\Incoming\IncomingSearchModel;

/**
 * IncomingRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class IncomingRepository extends EntityRepository
{
	/**
	 * @param IncomingSearchModel $incomingSearchModel
	 * @param bool                $returnQuery
	 *
	 * @return Incoming[]|\Doctrine\ORM\Query
	 */
	public function searchContainers(IncomingSearchModel $incomingSearchModel, $returnQuery = false)
	{
		$queryBuilder = $this->createQueryBuilder('i');
		if ($incomingSearchModel->getisComplete() === true) {
			$queryBuilder->andWhere('i.status = :complete')
				->setParameter('complete', IncomingStatus::COMPLETED);
		} elseif ($incomingSearchModel->getisComplete() === false) {
			$queryBuilder->andWhere('i.status != :complete')
				->setParameter('complete', IncomingStatus::COMPLETED);
		}

		if ($incomingSearchModel->getSearchString()) {
			$queryBuilder->andWhere($queryBuilder->expr()->like('i.name', ':searchString'))
				->setParameter('searchString', '%' . $incomingSearchModel->getSearchString() . '%');
		}

		foreach ($incomingSearchModel->getCriteria() as $param => $value) {
			$queryBuilder->andWhere("i.{$param} = '{$value}'");
		}

		foreach ($incomingSearchModel->getOrderBy() as $param => $order) {
			$queryBuilder->addOrderBy("i.{$param}", $order);
		}

		$searchEta = ($incomingSearchModel->getEtaStartDate() && $incomingSearchModel->getEtaEndDate()) ? true : false;
		if ($searchEta) {
			$queryBuilder->andWhere("i.eta > :startDate AND i.eta < :endDate")
				->setParameter('startDate', $incomingSearchModel->getEtaStartDate())
				->setParameter('endDate', $incomingSearchModel->getEtaEndDate());
		}

		$searchSchedule = ($incomingSearchModel->getScheduledEndDate() && $incomingSearchModel->getScheduledStartDate()) ? true : false;
		if ($searchSchedule) {
			if ($searchEta){
				$queryBuilder->orWhere("i.scheduled > :scheduledStartDate AND i.scheduled < :scheduledEndDate")
					->setParameter('scheduledStartDate', $incomingSearchModel->getScheduledStartDate())
					->setParameter('scheduledEndDate', $incomingSearchModel->getScheduledEndDate());
			}else{
				$queryBuilder->andWhere("i.scheduled > :scheduledStartDate AND i.scheduled < :scheduledEndDate")
					->setParameter('scheduledStartDate', $incomingSearchModel->getScheduledStartDate())
					->setParameter('scheduledEndDate', $incomingSearchModel->getScheduledEndDate());
			}
		}

		if (!$incomingSearchModel->getLimit()) {
			$queryBuilder->setMaxResults('25');
		} else {
			$queryBuilder->setMaxResults($incomingSearchModel->getLimit());
		}

		if ($incomingSearchModel->getOffset()) {
			$queryBuilder->setFirstResult($incomingSearchModel->getOffset());
		}

		$query = $queryBuilder->getQuery();
		if ($returnQuery) {
			return $query;
		}
		return $query->getResult();
	}
}
